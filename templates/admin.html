<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="/static/style.css">
  <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
</head>
<body>
  <div class="page admin-page">
    <h1>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
    <a href="/logout" class="admin-logout">üö™ –í—ã–π—Ç–∏</a>

    <div class="admin-filters">
      <a href="/admin">–í—Å–µ</a>
      <a href="/admin?status=–ù–æ–≤—ã–π">–ù–æ–≤—ã–µ</a>
      <a href="/admin?status=–í –æ–±—Ä–∞–±–æ—Ç–∫–µ">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</a>
      <a href="/admin?status=–í—ã–ø–æ–ª–Ω–µ–Ω">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</a>

      <span class="admin-separator"></span>

      <a href="/admin/masters" class="masters-btn">üë∑ –ú–∞—Å—Ç–µ—Ä–∞</a>
    </div>

    <div class="orders">
      {% for o in orders %}
        <div class="order-card status-{{ o.status|lower|replace(' ', '-') }}">
          
          <div class="order-info">
            <b>#{{ o.id }} ‚Äî {{ o.service }}</b><br>
            {{ o.name }} ‚Äî {{ o.phone }}<br>
            üìç {{ o.address }}<br>
            {% if o.comment %}üí¨ {{ o.comment }}<br>{% endif %}
            <small>–°—Ç–∞—Ç—É—Å: {{ o.status }}</small>
          </div>

          <div class="order-actions">
            <a href="/update_status/{{ o.id }}/–ù–æ–≤—ã–π">–ù–æ–≤—ã–π</a>
            <a href="/update_status/{{ o.id }}/–í –æ–±—Ä–∞–±–æ—Ç–∫–µ">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</a>
            <a href="/update_status/{{ o.id }}/–í—ã–ø–æ–ª–Ω–µ–Ω">–í—ã–ø–æ–ª–Ω–µ–Ω</a>
          </div>

          <form action="/assign_master" method="post" class="assign-form">
            <input type="hidden" name="order_id" value="{{ o.id }}">

            <select name="master_id" required>
              <option value="">–ù–∞–∑–Ω–∞—á–∏—Ç—å –º–∞—Å—Ç–µ—Ä–∞</option>
              {% for m in masters %}
                <option value="{{ m.id }}" {% if o.master_id == m.id %}selected{% endif %}>
                  {{ m.name }} ({{ m.service }})
                </option>
              {% endfor %}
            </select>

            <button type="submit">–ù–∞–∑–Ω–∞—á–∏—Ç—å</button>
          </form>

          {% if o.master_id %}
            <div class="assigned-master">
              üë∑ –ù–∞–∑–Ω–∞—á–µ–Ω –º–∞—Å—Ç–µ—Ä:
              {% for m in masters %}
                {% if m.id == o.master_id %}
                  <b>{{ m.name }}</b>
                {% endif %}
              {% endfor %}
            </div>
          {% endif %}

        </div>
      {% else %}
        <p>–ü–æ–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç.</p>
      {% endfor %}
    </div>

    <a href="/" class="admin-link">‚Üê –ù–∞ —Å–∞–π—Ç</a>
  </div>

  <audio id="notifySound">
    <source src="/static/notify.mp3" type="audio/mpeg">
  </audio>

  <script>
    let lastCount = 0;

    async function checkNewOrders() {
      try {
        const response = await fetch('/orders_count');
        const count = parseInt(await response.text());

        if (lastCount && count > lastCount) {
          document.getElementById('notifySound').play();
        }

        lastCount = count;
      } catch (e) {
        console.log("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–∫–∞–∑–æ–≤");
      }
    }

    checkNewOrders();
    setInterval(checkNewOrders, 5000);
  </script>

</body>
</html>
